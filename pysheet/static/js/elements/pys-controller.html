<link rel="import" href="/static/js/bower_components/polymer/polymer.html">
<link rel="import" href="/static/js/bower_components/polymer-ajax/polymer-ajax.html">
<link rel="import" href="/static/js/elements/pys-project.html">
<link rel="import" href="/static/js/elements/pys-dialog.html">
<link rel="import" href="/static/js/elements/pys-table.html">

<polymer-element name="pys-controller" attributes="projects tableName projectName">
    
    <template>
        <style type="text/css">
            .project-box {
                margin:     auto;
                min-width:  300px;
                width:      25%;
            }

            .new-project {
                background-color:   rgba(255,255,255,0.5);
                height:             50px;
                line-height:        50px;
                text-align:         center;
                width:              100%;
                font-size:          20px;
            }

            .new-project:hover {
                background-color:   #26AFD8;
                color:              #FFFFFF;
            }

        </style>
        
        <!-- initial loader -->
        <polymer-ajax id="projects" url="/projects" auto response="{{projects}}" handleAs="json">
        <!-- create new projects -->
        <polymer-ajax id="newProjectRequest" auto response="{{newProject}}">

        <pys-dialog id="dialog" 
                    content="What is the new project name?" 
                    response="{{newProjectName}}"></pys-dialog>

        <!-- menu view -->
        <template if="{{showMenuView}}">
            <div class="project-box">
                <template repeat="{{ project in projects }}">   
                    <pys-project name="{{project}}"></pys-project>
                </template>
                <div class="new-project" on-click="{{getNewProjectName}}">+</div>
            </div>
        </template>

        <!-- spreadshead/table view -->
        <pys-table id="table" name="{{tableName}}" project="{{projectName}}" visible="{{showTableView}}"></pys-table>
    </template>

    <script>
        Polymer('pys-controller', {
            showMenuView: true,
            showTableView: false,

            ready: function(){
                var me = this;
                this.addEventListener('open-table', function(e){
                    // switching views
                    this.showMenuView = false;
                    this.showTableView = true;

                    // requesting table data
                    this.tableName = e.detail.name;
                    this.projectName = e.detail.project;
                });

                this.addEventListener('open-menu', function(e){
                    this.showMenuView = true;
                    this.showTableView = false;
                });
            },

            createNewProject: function(newProjectName){
                this.$.newProjectRequest.method = "POST";
                this.$.newProjectRequest.url = '/create_project/' + newProjectName;
            },

            getNewProjectName: function(event, detail, sender){
                console.debug('create new project');
                this.$.dialog.visible = true;

                // listen for input
                var me = this;
                this.$.dialog.addEventListener('confirmed-entry', function(e){
                    var newProjectName = e.detail.content;
                    me.createNewProject(newProjectName);                    
                });
            },

            newProjectChanged: function(event, detail, sender){
                console.debug('new project was created: ' + this.newProject);
                // refresh the project list
                this.$.projects.go()
            },
        });
    </script>

</polymer-element>