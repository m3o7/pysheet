<link rel="import" href="/static/js/bower_components/polymer/polymer.html">
<link rel="import" href="/static/js/bower_components/polymer-ajax/polymer-ajax.html">

<polymer-element name="pys-table" attributes="name project visible data errorMsg showError sourceVisible source">
    
    <template>

        <style type="text/css">
            .table-outer-frame{
                margin:     auto;
                width:      90%;
                border:     1px solid #FFFFFF;
            }

            .top-menu {
                margin-bottom: 10px;
            }

            .menu-item {
                width:              150px;
                height:             50px;
                line-height:        50px;
                display:            inline-block;
                background-color:   #FFFFFF;
                color:              #26AFD8;
                text-align:         center;
                font-size:          20px;
            }

            .source {
                margin-bottom:      10px;
            }

            textarea {
                border:     none;
                width:      100%;
                height:     200px;
                resize:     vertical;
                padding:    0px;
                color:      #26AFD8;
                font-size:  20px;
            }

            textarea:focus {
                background-color: rgba(255, 255, 255, 0.9);
                outline: none;
            }

            table {
                width:  100%;
            }

            table, th, td{
                border-collapse:    collapse;
                border:             1px solid #fff;
            }


        </style>

        <!-- table data -->
        <polymer-ajax   id="tableData" 
                        url="/project/{{project}}/{{name}}/run" 
                        response="{{data}}" 
                        auto 
                        handleAs="json">

        <!-- load source code -->
        <polymer-ajax   id="sourceCode" 
                        url="/project/{{project}}/{{name}}/_source" 
                        response="{{source}}" 
                        auto>

        <!-- send source code -->
        <polymer-ajax   id="updateSourceCode" 
                        url="/project/{{project}}/{{name}}/_update_source"
                        body="{{source}}"
                        method="POST"
                        on-polymer-response="{{sourceUpdated}}"
                        response="{{source}"
                        contentType="text/plain">

        <template if="{{visible}}">
            <div class="table-outer-frame">
                <div class="top-menu">
                    <div class="menu-item" on-click="{{showMenu}}">back to menu</div>
                    <div class="menu-item" on-click="{{run}}">run</div>
                    <div class="menu-item" on-click="{{showSource}}">source</div>
                </div>

                <template if="{{sourceVisible}}">
                    <div class="source">
                        <textarea value="{{source}}"></textarea>
                    </div>
                </template>

                <template if="{{showError}}">
                    <div>{{errorMsg}}</div>
                </template>

                <div class="table-box">
                    <table>
                        <template repeat="{{ row in data }}">
                        <tr>
                            <template repeat="{{ field in row }}">
                            <td>{{field}}</td>
                            </template>
                        </tr>
                        </template>
                    </table>
                </div>
            </div>
        </template>
    </template>

    <script>
        Polymer('pys-table', {
            showError: false,
            sourceVisible: false,

            ready: function(){
                var me = this;
                this.addEventListener('polymer-error', function(){
                    me.data = [];
                    me.errorMsg = 'loading error';
                    me.showError = true;
                });
                this.addEventListener('polymer-response', function(){
                    me.showError = false;
                });
            },

            showMenu: function (event, detail, sender) {
                // open the menu again
                this.fire('open-menu');
            },

            showSource: function(event, detail, sender){
                this.sourceVisible = !this.sourceVisible;
            },

            sourceChanged: function(){
                console.debug("source has changed");
            },

            run: function(event, detail, sender){
                var me = this;
                // update the source code
                this.$.updateSourceCode.go();
                // clean up the data and indicate the load process
                this.data = [];
            },

            sourceUpdated: function(){
                // reload the data
                this.$.tableData.go();
            },

        });
    </script>

</polymer-element>
